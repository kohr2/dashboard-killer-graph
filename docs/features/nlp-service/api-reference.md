# API Reference

## Overview

RESTful API for NLP tasks with ontology scoping support.

## Base URL

- **Development**: `http://localhost:8000`
- **Production**: `https://your-domain.com`

## Endpoints

### Health Check

**GET** `/health`

```bash
curl http://localhost:8000/health
```

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00Z",
  "ontologies_loaded": ["financial", "procurement", "crm", "default"]
}
```

### Get Ontologies

**GET** `/ontologies`

```bash
curl -X GET http://localhost:8000/ontologies
```

**Response:**
```json
{
  "available_ontologies": ["financial", "procurement", "crm", "default"],
  "default_ontology": "default",
  "ontology_details": {
    "financial": {
      "entity_types": ["COMPANY_NAME", "PERSON_NAME", "MONETARY_AMOUNT"],
      "relationship_types": ["WORKS_FOR", "INVESTS", "OWNS"],
      "entity_count": 3,
      "relationship_count": 3
    }
  }
}
```

### Extract Entities

**POST** `/extract-entities`

```bash
curl -X POST http://localhost:8000/extract-entities \
  -H "Content-Type: application/json" \
  -d '{"text": "Apple Inc. CEO Tim Cook announced a $2 billion investment.", "ontology_name": "financial"}'
```

**Response:**
```json
[
  {
    "type": "COMPANY_NAME",
    "value": "Apple Inc.",
    "confidence": 0.85,
    "start": 0,
    "end": 9,
    "spacy_label": "ORG"
  },
  {
    "type": "PERSON_NAME",
    "value": "Tim Cook",
    "confidence": 0.85,
    "start": 13,
    "end": 21,
    "spacy_label": "PERSON"
  }
]
```

### Extract Graph

**POST** `/extract-graph`

```bash
curl -X POST http://localhost:8000/extract-graph \
  -H "Content-Type: application/json" \
  -d '{"text": "Apple Inc. CEO Tim Cook announced a $2 billion investment.", "ontology_name": "financial"}'
```

**Response:**
```json
{
  "entities": [
    {
      "type": "COMPANY_NAME",
      "value": "Apple Inc.",
      "confidence": 0.9,
      "properties": {"industry": "technology"}
    },
    {
      "type": "PERSON_NAME",
      "value": "Tim Cook",
      "confidence": 0.9,
      "properties": {"title": "CEO"}
    }
  ],
  "relationships": [
    {
      "source": "Tim Cook",
      "target": "Apple Inc.",
      "type": "WORKS_FOR",
      "confidence": 0.9,
      "properties": {"role": "CEO"}
    }
  ],
  "refinement_info": "Graph generated by LLM based on financial ontology.",
  "embedding": [0.1, 0.2, 0.3, ...],
  "ontology_used": "financial"
}
```

### Batch Extract Graph

**POST** `/batch-extract-graph`

```bash
curl -X POST http://localhost:8000/batch-extract-graph \
  -H "Content-Type: application/json" \
  -d '{"texts": ["Text 1", "Text 2", "Text 3"], "ontology_name": "financial"}'
```

**Response:**
```json
[
  {
    "entities": [...],
    "relationships": [...],
    "refinement_info": "...",
    "embedding": [...],
    "ontology_used": "financial"
  },
  {
    "entities": [...],
    "relationships": [...],
    "refinement_info": "...",
    "embedding": [...],
    "ontology_used": "financial"
  }
]
```

### Generate Embeddings

**POST** `/embed`

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{"texts": ["Apple Inc. CEO Tim Cook", "Microsoft Corp. quarterly earnings"]}'
```

**Response:**
```json
{
  "embeddings": [
    [0.1, 0.2, 0.3, ...],
    [0.4, 0.5, 0.6, ...]
  ],
  "model": "sentence-transformers/all-MiniLM-L6-v2",
  "dimension": 384
}
```

### Update Ontology

**POST** `/ontologies`

```bash
curl -X POST http://localhost:8000/ontologies \
  -H "Content-Type: application/json" \
  -d '{
    "entity_types": ["COMPANY_NAME", "PERSON_NAME"],
    "relationship_types": ["WORKS_FOR"],
    "compact_ontology": {
      "e": ["COMPANY_NAME", "PERSON_NAME"],
      "r": [["PERSON_NAME", "WORKS_FOR", "COMPANY_NAME"]]
    },
    "ontology_name": "custom"
  }'
```

**Response:** 204 No Content

## Request Models

### Entity Extraction Request
```json
{
  "text": "string (required)",
  "ontology_name": "string (optional, default: 'default')"
}
```

### Graph Extraction Request
```json
{
  "text": "string (required)",
  "ontology_name": "string (optional, default: 'default')"
}
```

### Batch Extraction Request
```json
{
  "texts": ["string (required, min 1, max 100)"],
  "ontology_name": "string (optional, default: 'default')"
}
```

### Embedding Request
```json
{
  "texts": ["string (required, min 1, max 1000)"]
}
```

### Ontology Update Request
```json
{
  "entity_types": ["string (required)"],
  "relationship_types": ["string (required)"],
  "compact_ontology": {
    "e": ["string"],
    "r": [["string", "string", "string"]]
  },
  "ontology_name": "string (required)"
}
```

## Response Models

### Entity
```json
{
  "type": "string",
  "value": "string",
  "confidence": "number (0-1)",
  "start": "number (optional)",
  "end": "number (optional)",
  "spacy_label": "string (optional)",
  "context": "string (optional)",
  "properties": {"string": "any (optional)"}
}
```

### Relationship
```json
{
  "source": "string",
  "target": "string",
  "type": "string",
  "confidence": "number (0-1)",
  "properties": {"string": "any (optional)"}
}
```

### Graph Response
```json
{
  "entities": ["Entity"],
  "relationships": ["Relationship"],
  "refinement_info": "string",
  "embedding": ["number"],
  "ontology_used": "string"
}
```

## Error Handling

### Error Response Format
```json
{
  "detail": "Error message description"
}
```

### Common Error Codes

| Status | Description | Example |
|--------|-------------|---------|
| `400` | Bad Request | Invalid JSON, missing fields |
| `422` | Validation Error | Invalid ontology name, text too long |
| `503` | Service Unavailable | OpenAI API not configured |
| `500` | Internal Server Error | Unexpected server error |

### Error Examples

**Ontology Not Found:**
```json
{
  "detail": "Ontology 'unknown_ontology' not found. Available: ['financial', 'procurement', 'crm', 'default']"
}
```

**OpenAI Not Configured:**
```json
{
  "detail": "OpenAI API key not configured"
}
```

**Text Too Long:**
```json
{
  "detail": "Text length (50000) exceeds maximum allowed length (10000)"
}
```

## Rate Limits

- **General API**: 10 requests/second
- **Extraction endpoints**: 5 requests/second
- **Batch extraction**: 3 requests/second
- **Embedding generation**: 20 requests/second

## Timeouts

- **Entity extraction**: 30 seconds
- **Graph extraction**: 300 seconds
- **Batch extraction**: 600 seconds
- **Embedding generation**: 120 seconds

## OpenAPI Documentation

- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`
- **OpenAPI JSON**: `http://localhost:8000/openapi.json` 